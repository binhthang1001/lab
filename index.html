<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Ấn Phẩm Xuất Bản</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện icon Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        /* Ẩn các view không hoạt động */
        .hidden-view {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Giao diện Trang Chủ -->
    <div id="homepage-view">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
            <header class="text-center mb-10">
                <h1 class="text-3xl sm:text-4xl font-bold text-red-700 uppercase flex items-center justify-center gap-3">
                    <i data-lucide="notebook-tabs"></i>
                    <span>Danh Sách Ấn Phẩm Xuất Bản</span>
                </h1>
                <p class="text-gray-500 mt-2">Dữ liệu được cập nhật tự động trong thời gian thực.</p>
            </header>
            <main class="bg-white p-6 rounded-lg shadow-md">
                <!-- Khu vực thống kê -->
                <div id="stats-container" class="mb-10 pb-6 border-b">
                    <p class="text-center text-gray-500">Đang tải thống kê...</p>
                </div>

                <!-- Danh sách ấn phẩm -->
                <div id="publication-list" class="space-y-6">
                    <p class="text-center py-10 text-gray-500">Đang tải dữ liệu...</p>
                </div>
            </main>
            <footer class="text-center mt-8">
                 <div id="manage-access-container">
                     <button id="go-to-manage-btn" class="btn px-5 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">
                        Đi đến trang quản lý
                     </button>
                </div>
                <div id="password-prompt-container" class="hidden-view max-w-xs mx-auto">
                     <input type="password" id="password-input" class="w-full px-3 py-2 border rounded-md text-center" placeholder="Nhập mật khẩu">
                     <button id="submit-password-btn" class="btn mt-2 px-5 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-800">Xác nhận</button>
                     <p id="password-error" class="text-red-500 text-sm mt-2 h-4"></p>
                </div>
            </footer>
        </div>
    </div>

    <!-- Giao diện Trang Quản Lý (ẩn ban đầu) -->
    <div id="management-view" class="hidden-view">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
            <header class="text-center mb-8 relative">
                <button id="go-to-home-btn" class="btn absolute top-0 left-0 px-3 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </button>
                <h1 class="text-3xl sm:text-4xl font-bold text-blue-600">Quản Lý Ấn Phẩm Xuất Bản</h1>
                <p class="text-gray-500 mt-2">Thêm, sửa, xóa các ấn phẩm trong danh sách công khai.</p>
                <div id="user-info" class="mt-4 text-sm text-gray-400">Đang kết nối...</div>
            </header>
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 id="form-title" class="text-2xl font-semibold mb-4 text-gray-700">Thêm Ấn Phẩm Mới</h2>
                <form id="publication-form" class="space-y-4">
                    <input type="hidden" id="publication-id">
                    <div>
                        <label for="publication-title" class="block text-sm font-medium text-gray-600">Tên bài báo</label>
                        <input type="text" id="publication-title" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                    </div>
                     <div>
                        <label for="publication-authors" class="block text-sm font-medium text-gray-600">Tên tác giả</label>
                        <input type="text" id="publication-authors" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="VD: Trần Bình Thắng, Binh Thang Tran, Nguyen Van A" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="publication-journal" class="block text-sm font-medium text-gray-600">Tạp chí</label>
                            <input type="text" id="publication-journal" class="mt-1 block w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label for="publication-volume" class="block text-sm font-medium text-gray-600">Tập (số)</label>
                            <input type="text" id="publication-volume" class="mt-1 block w-full px-3 py-2 border rounded-md">
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="publication-year" class="block text-sm font-medium text-gray-600">Năm</label>
                            <input type="number" id="publication-year" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="VD: 2025">
                        </div>
                        <div>
                            <label for="publication-category" class="block text-sm font-medium text-gray-600">Danh mục</label>
                            <select id="publication-category" class="mt-1 block w-full px-3 py-2 border rounded-md bg-white">
                                <option>WoS</option>
                                <option>SCOPUS</option>
                                <option>WoS/SCOPUS</option>
                                <option>Khác</option>
                            </select>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="publication-role" class="block text-sm font-medium text-gray-600">Vai trò</label>
                            <select id="publication-role" class="mt-1 block w-full px-3 py-2 border rounded-md bg-white">
                                <option>Tác giả chính</option>
                                <option>Đồng tác giả</option>
                            </select>
                        </div>
                        <div>
                            <label for="publication-link" class="block text-sm font-medium text-gray-600">Đường dẫn</label>
                            <input type="url" id="publication-link" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="https://...">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3">
                         <button type="button" id="cancel-edit-btn" class="btn hidden px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Hủy</button>
                        <button type="submit" id="submit-btn" class="btn px-6 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Thêm Ấn Phẩm</button>
                    </div>
                </form>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Danh Sách Hiện Tại</h2>
                    <button id="download-csv-btn" class="btn px-4 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 flex items-center gap-2">
                        <i data-lucide="download"></i>
                        Tải về (CSV)
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tên Bài Báo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tác Giả</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Năm</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Danh mục</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Hành Động</th>
                            </tr>
                        </thead>
                        <tbody id="publication-table-body" class="bg-white divide-y divide-gray-200">
                             <tr><td colspan="5" class="text-center py-10 text-gray-500">Đang tải...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tải các thư viện Firebase phiên bản tương thích (compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <!-- Toàn bộ logic ứng dụng được gói trong một thẻ script duy nhất -->
    <script>
        // Chạy toàn bộ mã sau khi trang đã tải xong
        window.onload = function() {
            // --- CẤU HÌNH VÀ KHỞI TẠO ---
            // **ĐÃ THAY THẾ BẰNG CẤU HÌNH CỦA BẠN**
            var firebaseConfig = {
              apiKey: "AIzaSyC8OirviWwIl0PKN3EyweiXX40S3EULbN0",
              authDomain: "ai-app-pubs.firebaseapp.com",
              projectId: "ai-app-pubs",
              storageBucket: "ai-app-pubs.appspot.com", // Sử dụng .appspot.com để tương thích tốt hơn
              messagingSenderId: "935991906705",
              appId: "1:935991906705:web:cb39304f8c5562f7c3ca30"
            };
            
            // Sử dụng một ID cố định cho đường dẫn Firestore
            var appId = 'ai-app-pubs';

            firebase.initializeApp(firebaseConfig);
            var db = firebase.firestore();
            var auth = firebase.auth();

            // --- THAM CHIẾU ĐẾN CÁC THÀNH PHẦN GIAO DIỆN ---
            var homepageView = document.getElementById('homepage-view');
            var managementView = document.getElementById('management-view');
            var goToManageBtn = document.getElementById('go-to-manage-btn');
            var goToHomeBtn = document.getElementById('go-to-home-btn');
            var manageAccessContainer = document.getElementById('manage-access-container');
            var passwordPromptContainer = document.getElementById('password-prompt-container');
            var submitPasswordBtn = document.getElementById('submit-password-btn');
            var passwordInput = document.getElementById('password-input');
            var passwordError = document.getElementById('password-error');
            var downloadCsvBtn = document.getElementById('download-csv-btn');

            // --- LOGIC CHUYỂN ĐỔI GIAO DIỆN & MẬT KHẨU ---
            function showHomepage() {
                homepageView.classList.remove('hidden-view');
                managementView.classList.add('hidden-view');
            }

            function showManagementPage() {
                homepageView.classList.add('hidden-view');
                managementView.classList.remove('hidden-view');
            }

            goToManageBtn.addEventListener('click', function() {
                manageAccessContainer.classList.add('hidden-view');
                passwordPromptContainer.classList.remove('hidden-view');
                passwordInput.focus();
            });

            var handlePasswordSubmit = function() {
                if (passwordInput.value === '1001') {
                    passwordError.textContent = '';
                    passwordInput.value = ''; 
                    manageAccessContainer.classList.remove('hidden-view');
                    passwordPromptContainer.classList.add('hidden-view');
                    showManagementPage();
                } else {
                    passwordError.textContent = 'Mật khẩu không chính xác.';
                    passwordInput.value = '';
                }
            };

            submitPasswordBtn.addEventListener('click', handlePasswordSubmit);
            passwordInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') handlePasswordSubmit();
            });

            goToHomeBtn.addEventListener('click', showHomepage);

            // --- LOGIC FIREBASE ---
            var publicationsCollectionRef = null;

            var seedData = [
                { title: 'A novel approach to machine learning in bioinformatics', authors: 'Binh Thang Tran, Nguyen Van A', journal: 'Journal of Computer Science', volume: '15(2)', year: '2025', category: 'WoS', role: 'Tác giả chính', link: '#' },
                { title: 'The impact of AI on modern agriculture', authors: 'Le Thi B, Trần Bình Thắng', journal: 'International Agriculture Review', volume: '8(4)', year: '2025', category: 'SCOPUS', role: 'Đồng tác giả', link: '#' },
                { title: 'Data Structures and Their Applications', authors: 'Pham Van C, Nguyen Thi D', journal: 'Tech Journal', volume: '22', year: '2024', category: 'Khác', role: 'Đồng tác giả', link: '#' },
                { title: 'Exploring the Vietnamese linguistic model', authors: 'Trần Bình Thắng', journal: 'Linguistics Today', volume: '5(1)', year: '2024', category: 'WoS/SCOPUS', role: 'Tác giả chính', link: '#' }
            ];
            
            function mainApp() {
                var authPromise;
                if (auth.currentUser) {
                    authPromise = Promise.resolve({ user: auth.currentUser });
                } else {
                    authPromise = auth.signInAnonymously();
                }

                authPromise.then(function(userCredential) {
                    var user = userCredential.user;
                    console.log("Authenticated with UserID:", user.uid);
                    document.getElementById('user-info').textContent = 'UserID: ' + user.uid;
                    publicationsCollectionRef = db.collection('artifacts/' + appId + '/public/data/publications');
                    
                    return seedInitialData();
                }).then(function() {
                    console.log("Initialization complete. Setting up listeners.");
                    listenForHomepageData();
                    listenForManagementData();
                }).catch(function(error) {
                    console.error("Lỗi khởi tạo ứng dụng hoặc xác thực:", error);
                    var listContainer = document.getElementById('publication-list');
                    if(listContainer) {
                        listContainer.innerHTML = '<p class="text-center py-10 text-red-500">Không thể tải ứng dụng. Vui lòng kiểm tra kết nối và thử lại.</p>';
                    }
                });
            }

            function seedInitialData() {
                return new Promise(function(resolve, reject) {
                    if (!publicationsCollectionRef) {
                        resolve();
                        return;
                    }
                    publicationsCollectionRef.get().then(function(snapshot) {
                        if (snapshot.empty) {
                            console.log('No data found. Seeding initial publications...');
                            var addPromises = seedData.map(function(pub) {
                                return publicationsCollectionRef.add(pub);
                            });
                            Promise.all(addPromises).then(resolve).catch(reject);
                        } else {
                            console.log('Data already exists. Skipping seed.');
                            resolve();
                        }
                    }).catch(reject);
                });
            }

            // Start the application
            mainApp();

            // Lắng nghe và hiển thị dữ liệu cho Trang Chủ
            function listenForHomepageData() {
                if (!publicationsCollectionRef) return;
                var listContainer = document.getElementById('publication-list');
                var statsContainer = document.getElementById('stats-container');

                publicationsCollectionRef.onSnapshot(function(snapshot) {
                    listContainer.innerHTML = '';
                    
                    if (snapshot.empty) {
                        listContainer.innerHTML = '<p class="text-center py-10 text-gray-500">Chưa có ấn phẩm nào.</p>';
                        statsContainer.innerHTML = '<p class="text-center text-gray-500">Chưa có dữ liệu để thống kê.</p>';
                        return;
                    }

                    var allDocs = [];
                    snapshot.forEach(function(doc){ allDocs.push(doc); });

                    var stats = { 'WoS': 0, 'SCOPUS': 0, 'WoS/SCOPUS': 0, 'Khác': 0, 'Total': 0 };
                    allDocs.forEach(function(doc) {
                        var pub = doc.data();
                        if (pub.category && stats.hasOwnProperty(pub.category)) stats[pub.category]++;
                        stats.Total++;
                    });

                    statsContainer.innerHTML = [
                        '<div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">',
                            '<div class="p-4 bg-gray-50 rounded-lg"><h3 class="text-sm sm:text-base font-semibold text-gray-500 uppercase">TỔNG SỐ</h3><p class="text-4xl sm:text-5xl font-bold text-gray-800">' + stats.Total + '</p></div>',
                            '<div class="p-4 bg-blue-50 rounded-lg"><h3 class="text-sm sm:text-base font-semibold text-blue-500 uppercase">WoS</h3><p class="text-4xl sm:text-5xl font-bold text-blue-600">' + stats.WoS + '</p></div>',
                            '<div class="p-4 bg-green-50 rounded-lg"><h3 class="text-sm sm:text-base font-semibold text-green-500 uppercase">SCOPUS</h3><p class="text-4xl sm:text-5xl font-bold text-green-600">' + stats.SCOPUS + '</p></div>',
                            '<div class="p-4 bg-purple-50 rounded-lg"><h3 class="text-sm sm:text-base font-semibold text-purple-500 uppercase">WoS/SCOPUS</h3><p class="text-4xl sm:text-5xl font-bold text-purple-600">' + stats['WoS/SCOPUS'] + '</p></div>',
                            '<div class="p-4 bg-yellow-50 rounded-lg"><h3 class="text-sm sm:text-base font-semibold text-yellow-500 uppercase">KHÁC</h3><p class="text-4xl sm:text-5xl font-bold text-yellow-600">' + stats['Khác'] + '</p></div>',
                        '</div>'
                    ].join('');

                    var groupedByYear = allDocs.reduce(function(acc, doc) {
                        var year = doc.data().year || 'Chưa rõ';
                        if (!acc[year]) acc[year] = [];
                        acc[year].push(doc);
                        return acc;
                    }, {});

                    var sortedYears = Object.keys(groupedByYear).sort(function(a, b) { return b - a; });
                    
                    var counter = 1;
                    sortedYears.forEach(function(year) {
                        var yearHeader = document.createElement('h2');
                        yearHeader.className = 'text-2xl font-bold mt-8 mb-2 border-b pb-2';
                        yearHeader.textContent = 'Năm ' + year;
                        listContainer.appendChild(yearHeader);

                        var pubsInYear = groupedByYear[year];
                        pubsInYear.sort(function(a, b) { return (a.data().title || '').localeCompare(b.data().title || ''); });

                        pubsInYear.forEach(function(doc) {
                            var pub = doc.data();
                            var item = document.createElement('div');
                            item.className = 'text-base leading-relaxed flex items-start';
                            
                            var authorsString = pub.authors || '';
                            var authorsHtml = authorsString.split(',').map(function(name) {
                                var trimmedName = name.trim();
                                if (trimmedName === 'Trần Bình Thắng' || trimmedName === 'Binh Thang Tran') {
                                    return '<strong class="font-bold text-red-800">' + trimmedName + '</strong>';
                                }
                                return trimmedName;
                            }).join(', ');

                            var titleLink = pub.link ? '<a href="' + pub.link + '" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:underline">' + pub.title + '</a>' : pub.title;
                            var journalDisplay = pub.journal ? '<em class="italic">' + pub.journal + (pub.volume ? ', ' + pub.volume : '') + '</em>.' : '';

                            item.innerHTML = [
                                '<span class="mr-3 text-gray-500">' + counter + '.</span>',
                                '<p>',
                                    authorsHtml,
                                    '(' + (pub.year || 'N/A') + '). ',
                                    titleLink + '. ',
                                    journalDisplay,
                                    ' <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded">' + (pub.category || '') + '</span>. ',
                                    '<strong class="font-bold text-gray-800">' + (pub.role || '') + '</strong>',
                                '</p>'
                            ].join('');
                            listContainer.appendChild(item);
                            counter++;
                        });
                    });
                });
            }

            // Lắng nghe và hiển thị dữ liệu cho Trang Quản Lý
            function listenForManagementData() {
                if (!publicationsCollectionRef) return;
                var tableBody = document.getElementById('publication-table-body');
                publicationsCollectionRef.onSnapshot(function(snapshot) {
                    tableBody.innerHTML = '';
                    if (snapshot.empty) {
                         tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-gray-500">Chưa có ấn phẩm nào.</td></tr>';
                    }
                    var sortedDocs = [];
                    snapshot.forEach(function(doc){ sortedDocs.push(doc); });
                    sortedDocs.sort(function(a, b) { return (parseInt(b.data().year, 10) || 0) - (parseInt(a.data().year, 10) || 0); });
                    
                    sortedDocs.forEach(function(doc) {
                        var pub = doc.data();
                        var row = document.createElement('tr');
                        row.innerHTML = [
                            '<td class="px-6 py-4"><div class="text-sm font-medium text-gray-900">' + pub.title + '</div></td>',
                            '<td class="px-6 py-4"><div class="text-sm text-gray-600">' + pub.authors + '</div></td>',
                            '<td class="px-6 py-4"><div class="text-sm text-gray-600">' + pub.year + '</div></td>',
                            '<td class="px-6 py-4"><div class="text-sm text-gray-600">' + pub.category + '</div></td>',
                            '<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">',
                                '<button class="edit-btn text-blue-600 hover:text-blue-900 mr-3" data-id="' + doc.id + '"><i data-lucide="file-pen-line" class="w-5 h-5"></i></button>',
                                '<button class="delete-btn text-red-600 hover:text-red-900" data-id="' + doc.id + '"><i data-lucide="trash-2" class="w-5 h-5"></i></button>',
                            '</td>'
                        ].join('');
                        tableBody.appendChild(row);
                    });
                    lucide.createIcons();
                });
            }

            // --- LOGIC FORM QUẢN LÝ (Thêm, Sửa, Xóa) ---
            var publicationForm = document.getElementById('publication-form');
            var formTitle = document.getElementById('form-title');
            var submitBtn = document.getElementById('submit-btn');
            var cancelBtn = document.getElementById('cancel-edit-btn');
            var publicationIdInput = document.getElementById('publication-id');

            publicationForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (!publicationsCollectionRef) return;
                var publicationData = {
                    title: document.getElementById('publication-title').value,
                    authors: document.getElementById('publication-authors').value,
                    journal: document.getElementById('publication-journal').value,
                    volume: document.getElementById('publication-volume').value,
                    year: document.getElementById('publication-year').value,
                    category: document.getElementById('publication-category').value,
                    role: document.getElementById('publication-role').value,
                    link: document.getElementById('publication-link').value,
                };
                var id = publicationIdInput.value;
                if (id) {
                    publicationsCollectionRef.doc(id).update(publicationData).then(resetForm).catch(function(err){ console.error("Lỗi khi cập nhật: ", err); });
                } else {
                    publicationsCollectionRef.add(publicationData).then(resetForm).catch(function(err){ console.error("Lỗi khi thêm: ", err); });
                }
            });

            document.getElementById('management-view').addEventListener('click', function(e) {
                var button = e.target.closest('button.edit-btn, button.delete-btn');
                if (!button || !publicationsCollectionRef) return;

                var id = button.dataset.id;
                var docRef = publicationsCollectionRef.doc(id);

                if (button.classList.contains('delete-btn')) {
                    if (confirm('Bạn có chắc chắn muốn xóa ấn phẩm này không?')) {
                        docRef.delete();
                    }
                } else if (button.classList.contains('edit-btn')) {
                    docRef.get().then(function(doc) {
                        if (doc.exists) {
                            var data = doc.data();
                            publicationIdInput.value = id;
                            document.getElementById('publication-title').value = data.title || '';
                            document.getElementById('publication-authors').value = data.authors || '';
                            document.getElementById('publication-journal').value = data.journal || '';
                            document.getElementById('publication-volume').value = data.volume || '';
                            document.getElementById('publication-year').value = data.year || '';
                            document.getElementById('publication-category').value = data.category || 'Khác';
                            document.getElementById('publication-role').value = data.role || 'Tác giả chính';
                            document.getElementById('publication-link').value = data.link || '';

                            formTitle.textContent = 'Chỉnh Sửa Ấn Phẩm';
                            submitBtn.textContent = 'Cập Nhật';
                            submitBtn.classList.remove('bg-blue-600');
                            submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                            cancelBtn.classList.remove('hidden');
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                }
            });

            function resetForm() {
                publicationForm.reset();
                publicationIdInput.value = '';
                formTitle.textContent = 'Thêm Ấn Phẩm Mới';
                submitBtn.textContent = 'Thêm Ấn Phẩm';
                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitBtn.classList.add('bg-blue-600');
                cancelBtn.classList.add('hidden');
            }
            cancelBtn.addEventListener('click', resetForm);
            
            // --- LOGIC TẢI CSV ---
            var downloadCSV = function() {
                if (!publicationsCollectionRef) {
                    alert("Chưa kết nối tới cơ sở dữ liệu.");
                    return;
                }
                publicationsCollectionRef.get().then(function(snapshot) {
                    if (snapshot.empty) {
                        alert("Không có dữ liệu để tải về.");
                        return;
                    }

                    var headers = ["Tên bài báo", "Tên tác giả", "Tạp chí", "Tập (số)", "Năm", "Danh mục", "Vai trò", "Đường dẫn"];
                    
                    var escapeCsvCell = function(cell) {
                        if (cell === null || cell === undefined) return '';
                        var strCell = String(cell);
                        if (strCell.includes(',') || strCell.includes('"') || strCell.includes('\n')) {
                            return '"' + strCell.replace(/"/g, '""') + '"';
                        }
                        return strCell;
                    };

                    var csvRows = [headers.join(',')];
                    snapshot.forEach(function(doc) {
                        var data = doc.data();
                        var row = [
                            escapeCsvCell(data.title),
                            escapeCsvCell(data.authors),
                            escapeCsvCell(data.journal),
                            escapeCsvCell(data.volume),
                            escapeCsvCell(data.year),
                            escapeCsvCell(data.category),
                            escapeCsvCell(data.role),
                            escapeCsvCell(data.link)
                        ];
                        csvRows.push(row.join(','));
                    });

                    var csvString = csvRows.join('\n');
                    var blob = new Blob(['\uFEFF' + csvString], { type: 'text/csv;charset=utf-8;' });
                    
                    var link = document.createElement("a");
                    var url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", "danh-sach-an-pham.csv");
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }).catch(function(error) {
                    console.error("Lỗi khi tải file CSV:", error);
                    alert("Đã xảy ra lỗi khi tải file.");
                });
            };

            downloadCsvBtn.addEventListener('click', downloadCSV);

            // Khởi tạo icons
            lucide.createIcons();
        };
    </script>
</body>
</html>
