<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Ấn Phẩm Xuất Bản</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện icon Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Tải Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-slab {
            font-family: 'Roboto Slab', serif;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        /* Ẩn các view không hoạt động */
        .hidden-view {
            display: none;
        }
        /* Style cho nút ngôn ngữ */
        .lang-btn.active {
            background-color: #3B82F6; /* bg-blue-600 */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Giao diện Trang Chủ -->
    <div id="homepage-view">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl relative">
            <div id="lang-switcher-home" class="absolute top-4 right-4 flex space-x-1 border rounded-lg p-1 bg-gray-200">
                <button data-lang="vi" class="lang-btn active px-3 py-1 text-sm font-bold rounded-md">VN</button>
                <button data-lang="en" class="lang-btn px-3 py-1 text-sm font-bold rounded-md">EN</button>
            </div>
            <header class="text-center mb-10">
                <h1 class="text-3xl sm:text-4xl font-bold text-red-700 uppercase flex items-center justify-center gap-3">
                    <i data-lucide="notebook-tabs"></i>
                    <span data-translate="mainTitle">Danh Sách Ấn Phẩm Xuất Bản</span>
                </h1>
                <p class="text-gray-500 mt-2" data-translate="mainSubtitle">Dữ liệu được cập nhật tự động trong thời gian thực.</p>
            </header>
            <main class="bg-white p-6 rounded-lg shadow-md">
                <!-- Khu vực thống kê tổng quan -->
                <div id="stats-container" class="mb-6 pb-6 border-b">
                    <p class="text-center text-gray-500" data-translate="statsLoading">Đang tải thống kê...</p>
                </div>
                <!-- Khu vực thống kê chi tiết -->
                <div id="detailed-stats-container" class="mb-10 pb-6 border-b">
                     <p class="text-center text-gray-500" data-translate="statsLoading">Đang tải thống kê...</p>
                </div>

                <!-- Danh sách ấn phẩm -->
                <div id="publication-list" class="space-y-6">
                    <p class="text-center py-10 text-gray-500" data-translate="dataLoading">Đang tải dữ liệu...</p>
                </div>
            </main>
            <footer class="text-center mt-8">
                 <div id="manage-access-container">
                     <button id="go-to-manage-btn" class="btn px-5 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700" data-translate="goToManage">
                        Đi đến trang quản lý
                     </button>
                </div>
                <div id="password-prompt-container" class="hidden-view max-w-xs mx-auto">
                     <input type="password" id="password-input" class="w-full px-3 py-2 border rounded-md text-center" data-translate-placeholder="passwordPlaceholder">
                     <button id="submit-password-btn" class="btn mt-2 px-5 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-800" data-translate="passwordConfirm">Xác nhận</button>
                     <p id="password-error" class="text-red-500 text-sm mt-2 h-4"></p>
                </div>
            </footer>
        </div>
    </div>

    <!-- Giao diện Trang Quản Lý (ẩn ban đầu) -->
    <div id="management-view" class="hidden-view">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
            <header class="text-center mb-8 relative">
                <div id="lang-switcher-manage" class="absolute top-4 right-4 flex space-x-1 border rounded-lg p-1 bg-gray-200">
                    <button data-lang="vi" class="lang-btn active px-3 py-1 text-sm font-bold rounded-md">VN</button>
                    <button data-lang="en" class="lang-btn px-3 py-1 text-sm font-bold rounded-md">EN</button>
                </div>
                <button id="go-to-home-btn" class="btn absolute top-4 left-4 px-3 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </button>
                <h1 class="text-3xl sm:text-4xl font-bold text-blue-600" data-translate="manageTitle">Quản Lý Ấn Phẩm Xuất Bản</h1>
                <p class="text-gray-500 mt-2" data-translate="manageSubtitle">Thêm, sửa, xóa các ấn phẩm trong danh sách công khai.</p>
                <div id="user-info" class="mt-4 text-sm text-gray-400" data-translate="connecting">Đang kết nối...</div>
            </header>
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 id="form-title" class="text-2xl font-semibold mb-4 text-gray-700" data-translate="addNewPublication">Thêm Ấn Phẩm Mới</h2>
                <form id="publication-form" class="space-y-4">
                    <input type="hidden" id="publication-id">
                    <div>
                        <label for="publication-title" class="block text-sm font-medium text-gray-600" data-translate="titleLabel">Tên bài báo</label>
                        <input type="text" id="publication-title" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                    </div>
                     <div>
                        <label for="publication-authors" class="block text-sm font-medium text-gray-600" data-translate="authorsLabel">Tên tác giả</label>
                        <input type="text" id="publication-authors" class="mt-1 block w-full px-3 py-2 border rounded-md" data-translate-placeholder="authorsPlaceholder" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="publication-journal" class="block text-sm font-medium text-gray-600" data-translate="journalLabel">Tạp chí</label>
                            <input type="text" id="publication-journal" class="mt-1 block w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label for="publication-volume" class="block text-sm font-medium text-gray-600" data-translate="volumeLabel">Tập (số)</label>
                            <input type="text" id="publication-volume" class="mt-1 block w-full px-3 py-2 border rounded-md">
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="publication-year" class="block text-sm font-medium text-gray-600" data-translate="yearLabel">Năm</label>
                            <input type="number" id="publication-year" class="mt-1 block w-full px-3 py-2 border rounded-md" data-translate-placeholder="yearPlaceholder">
                        </div>
                        <div>
                            <label for="publication-category" class="block text-sm font-medium text-gray-600" data-translate="categoryLabel">Danh mục</label>
                            <select id="publication-category" class="mt-1 block w-full px-3 py-2 border rounded-md bg-white">
                                <option>WoS</option>
                                <option>SCOPUS</option>
                                <option>WoS/SCOPUS</option>
                                <option data-translate="other">Khác</option>
                            </select>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="publication-role" class="block text-sm font-medium text-gray-600" data-translate="roleLabel">Vai trò</label>
                            <select id="publication-role" class="mt-1 block w-full px-3 py-2 border rounded-md bg-white">
                                <option data-translate="mainAuthor">Tác giả chính</option>
                                <option data-translate="coAuthor">Đồng tác giả</option>
                            </select>
                        </div>
                        <div>
                            <label for="publication-link" class="block text-sm font-medium text-gray-600" data-translate="linkLabel">Đường dẫn</label>
                            <input type="url" id="publication-link" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="https://...">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3">
                         <button type="button" id="cancel-edit-btn" class="btn hidden px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400" data-translate="cancelBtn">Hủy</button>
                        <button type="submit" id="submit-btn" class="btn px-6 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700" data-translate="addBtn">Thêm Ấn Phẩm</button>
                    </div>
                </form>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700" data-translate="currentList">Danh Sách Hiện Tại</h2>
                    <button id="download-csv-btn" class="btn px-4 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 flex items-center gap-2">
                        <i data-lucide="download"></i>
                        <span data-translate="downloadCSV">Tải về (CSV)</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-translate="colTitle">Tên Bài Báo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-translate="colAuthors">Tác Giả</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-translate="colYear">Năm</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-translate="colCategory">Danh mục</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase" data-translate="colActions">Hành Động</th>
                            </tr>
                        </thead>
                        <tbody id="publication-table-body" class="bg-white divide-y divide-gray-200">
                             <tr><td colspan="5" class="text-center py-10 text-gray-500">Đang tải...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tải các thư viện Firebase phiên bản tương thích (compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <!-- Toàn bộ logic ứng dụng được gói trong một thẻ script duy nhất -->
    <script>
        window.onload = function() {
            // --- CẤU HÌNH VÀ KHỞI TẠO ---
            var firebaseConfig = {
              apiKey: "AIzaSyC8OirviWwIl0PKN3EyweiXX40S3EULbN0",
              authDomain: "ai-app-pubs.firebaseapp.com",
              projectId: "ai-app-pubs",
              storageBucket: "ai-app-pubs.appspot.com",
              messagingSenderId: "935991906705",
              appId: "1:935991906705:web:cb39304f8c5562f7c3ca30"
            };
            var appId = 'ai-app-pubs';

            firebase.initializeApp(firebaseConfig);
            var db = firebase.firestore();
            var auth = firebase.auth();

            // --- LOGIC ĐA NGÔN NGỮ ---
            var currentLang = 'vi';
            var lastSnapshot = null;
            var translations = {
                vi: {
                    mainTitle: "Danh Sách Ấn Phẩm Xuất Bản", mainSubtitle: "Dữ liệu được cập nhật tự động trong thời gian thực.",
                    statsLoading: "Đang tải thống kê...", dataLoading: "Đang tải dữ liệu...",
                    goToManage: "Đi đến trang quản lý", passwordPlaceholder: "Nhập mật khẩu",
                    passwordConfirm: "Xác nhận", passwordError: "Mật khẩu không chính xác.",
                    totalCount: "TỔNG SỐ", other: "KHÁC", yearPrefix: "Năm ", noPublications: "Chưa có ấn phẩm nào.",
                    noStats: "Chưa có dữ liệu để thống kê.", manageTitle: "Quản Lý Ấn Phẩm Xuất Bản",
                    manageSubtitle: "Thêm, sửa, xóa các ấn phẩm trong danh sách công khai.",
                    connecting: "Đang kết nối...", addNewPublication: "Thêm Ấn Phẩm Mới",
                    editPublication: "Chỉnh Sửa Ấn Phẩm", titleLabel: "Tên bài báo",
                    authorsLabel: "Tên tác giả", authorsPlaceholder: "VD: Trần Bình Thắng, Binh Thang Tran",
                    journalLabel: "Tạp chí", volumeLabel: "Tập (số)", yearLabel: "Năm",
                    yearPlaceholder: "VD: 2025", categoryLabel: "Danh mục", roleLabel: "Vai trò",
                    linkLabel: "Đường dẫn", addBtn: "Thêm Ấn Phẩm", updateBtn: "Cập Nhật", cancelBtn: "Hủy",
                    currentList: "Danh Sách Hiện Tại", downloadCSV: "Tải về (CSV)",
                    colTitle: "Tên Bài Báo", colAuthors: "Tác Giả", colYear: "Năm",
                    colCategory: "Danh mục", colActions: "Hành Động", mainAuthor: "Tác giả chính",
                    coAuthor: "Đồng tác giả", confirmDelete: "Bạn có chắc chắn muốn xóa ấn phẩm này không?",
                    noDataToDownload: "Không có dữ liệu để tải về.", downloadError: "Đã xảy ra lỗi khi tải file.",
                    statsMainAuthor: "Tác giả chính", statsCoAuthor: "Đồng tác giả",
                    internationalArticles: "Bài báo quốc tế", domesticArticles: "Bài báo trong nước"
                },
                en: {
                    mainTitle: "List of Publications", mainSubtitle: "Data is updated automatically in real-time.",
                    statsLoading: "Loading statistics...", dataLoading: "Loading data...",
                    goToManage: "Go to Management Page", passwordPlaceholder: "Enter password",
                    passwordConfirm: "Confirm", passwordError: "Incorrect password.",
                    totalCount: "TOTAL", other: "OTHER", yearPrefix: "Year ", noPublications: "No publications yet.",
                    noStats: "No data for statistics.", manageTitle: "Publication Management",
                    manageSubtitle: "Add, edit, and delete publications from the public list.",
                    connecting: "Connecting...", addNewPublication: "Add New Publication",
                    editPublication: "Edit Publication", titleLabel: "Article Title",
                    authorsLabel: "Authors", authorsPlaceholder: "E.g., Binh Thang Tran, John Doe",
                    journalLabel: "Journal", volumeLabel: "Volume (Issue)", yearLabel: "Year",
                    yearPlaceholder: "E.g., 2025", categoryLabel: "Category", roleLabel: "Role",
                    linkLabel: "Link", addBtn: "Add Publication", updateBtn: "Update", cancelBtn: "Cancel",
                    currentList: "Current List", downloadCSV: "Download (CSV)",
                    colTitle: "Article Title", colAuthors: "Authors", colYear: "Year",
                    colCategory: "Category", colActions: "Actions", mainAuthor: "Main Author",
                    coAuthor: "Co-author", confirmDelete: "Are you sure you want to delete this publication?",
                    noDataToDownload: "No data to download.", downloadError: "An error occurred while downloading the file.",
                    statsMainAuthor: "Main Author", statsCoAuthor: "Co-author",
                    internationalArticles: "International Articles", domesticArticles: "Domestic Articles"
                }
            };

            function setLanguage(lang) {
                if (!translations[lang]) return;
                currentLang = lang;
                document.querySelectorAll('[data-translate]').forEach(function(el) {
                    var key = el.getAttribute('data-translate');
                    if (translations[lang][key]) el.textContent = translations[lang][key];
                });
                document.querySelectorAll('[data-translate-placeholder]').forEach(function(el) {
                    var key = el.getAttribute('data-translate-placeholder');
                    if (translations[lang][key]) el.placeholder = translations[lang][key];
                });
                document.querySelectorAll('.lang-btn').forEach(function(btn) {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-lang') === lang) btn.classList.add('active');
                });
                if(lastSnapshot) {
                    renderHomepageData(lastSnapshot);
                    renderManagementData(lastSnapshot);
                }
            }

            // --- THAM CHIẾU ĐẾN CÁC THÀNH PHẦN GIAO DIỆN ---
            var homepageView = document.getElementById('homepage-view');
            var managementView = document.getElementById('management-view');
            var goToManageBtn = document.getElementById('go-to-manage-btn');
            var goToHomeBtn = document.getElementById('go-to-home-btn');
            var manageAccessContainer = document.getElementById('manage-access-container');
            var passwordPromptContainer = document.getElementById('password-prompt-container');
            var submitPasswordBtn = document.getElementById('submit-password-btn');
            var passwordInput = document.getElementById('password-input');
            var passwordError = document.getElementById('password-error');
            var downloadCsvBtn = document.getElementById('download-csv-btn');

            // --- LOGIC CHUYỂN ĐỔI GIAO DIỆN & MẬT KHẨU ---
            function showHomepage() {
                homepageView.classList.remove('hidden-view');
                managementView.classList.add('hidden-view');
            }

            function showManagementPage() {
                homepageView.classList.add('hidden-view');
                managementView.classList.remove('hidden-view');
            }

            goToManageBtn.addEventListener('click', function() {
                manageAccessContainer.classList.add('hidden-view');
                passwordPromptContainer.classList.remove('hidden-view');
                passwordInput.focus();
            });

            var handlePasswordSubmit = function() {
                if (passwordInput.value === '1001') {
                    passwordError.textContent = '';
                    passwordInput.value = ''; 
                    manageAccessContainer.classList.remove('hidden-view');
                    passwordPromptContainer.classList.add('hidden-view');
                    showManagementPage();
                } else {
                    passwordError.textContent = translations[currentLang].passwordError;
                }
            };

            submitPasswordBtn.addEventListener('click', handlePasswordSubmit);
            passwordInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') handlePasswordSubmit();
            });

            goToHomeBtn.addEventListener('click', showHomepage);

            // --- LOGIC FIREBASE ---
            var publicationsCollectionRef = null;

            var seedData = [
                { title: 'A novel approach to machine learning in bioinformatics', authors: 'Binh Thang Tran, Nguyen Van A', journal: 'Journal of Computer Science', volume: '15(2)', year: '2025', category: 'WoS', role: 'Tác giả chính', link: '#' },
                { title: 'The impact of AI on modern agriculture', authors: 'Le Thi B, Trần Bình Thắng', journal: 'International Agriculture Review', volume: '8(4)', year: '2025', category: 'SCOPUS', role: 'Đồng tác giả', link: '#' },
                { title: 'Data Structures and Their Applications', authors: 'Pham Van C, Nguyen Thi D', journal: 'Tech Journal', volume: '22', year: '2024', category: 'Khác', role: 'Tác giả chính', link: '#' },
                { title: 'Exploring the Vietnamese linguistic model', authors: 'Trần Bình Thắng', journal: 'Linguistics Today', volume: '5(1)', year: '2024', category: 'WoS/SCOPUS', role: 'Tác giả chính', link: '#' }
            ];
            
            function mainApp() {
                var authPromise = auth.currentUser ? Promise.resolve({ user: auth.currentUser }) : auth.signInAnonymously();
                authPromise.then(function(userCredential) {
                    var user = userCredential.user;
                    document.getElementById('user-info').textContent = 'UserID: ' + user.uid;
                    publicationsCollectionRef = db.collection('artifacts/' + appId + '/public/data/publications');
                    return seedInitialData();
                }).then(function() {
                    listenForData();
                }).catch(function(error) {
                    console.error("Lỗi khởi tạo ứng dụng hoặc xác thực:", error);
                });
            }

            function seedInitialData() {
                return new Promise(function(resolve, reject) {
                    if (!publicationsCollectionRef) return resolve();
                    publicationsCollectionRef.get().then(function(snapshot) {
                        if (snapshot.empty) {
                            var addPromises = seedData.map(function(pub) { return publicationsCollectionRef.add(pub); });
                            Promise.all(addPromises).then(resolve).catch(reject);
                        } else {
                            resolve();
                        }
                    }).catch(reject);
                });
            }

            mainApp();

            function listenForData() {
                if (!publicationsCollectionRef) return;
                publicationsCollectionRef.onSnapshot(function(snapshot) {
                    lastSnapshot = snapshot;
                    renderHomepageData(snapshot);
                    renderManagementData(snapshot);
                });
            }
            
            function renderHomepageData(snapshot) {
                var listContainer = document.getElementById('publication-list');
                var statsContainer = document.getElementById('stats-container');
                var detailedStatsContainer = document.getElementById('detailed-stats-container');
                listContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-center py-10 text-gray-500">' + translations[currentLang].noPublications + '</p>';
                    statsContainer.innerHTML = '<p class="text-center text-gray-500">' + translations[currentLang].noStats + '</p>';
                    detailedStatsContainer.innerHTML = '';
                    return;
                }

                var allDocs = [];
                snapshot.forEach(function(doc){ allDocs.push(doc); });

                var stats = { 'WoS': 0, 'SCOPUS': 0, 'WoS/SCOPUS': 0, 'Khác': 0, 'Total': 0 };
                var roleStats = {
                    international: { mainAuthor: 0, coAuthor: 0 },
                    domestic: { mainAuthor: 0, coAuthor: 0 }
                };
                var internationalCategories = ['WoS', 'SCOPUS', 'WoS/SCOPUS'];

                allDocs.forEach(function(doc) {
                    var pub = doc.data();
                    if (pub.category && stats.hasOwnProperty(pub.category)) stats[pub.category]++;
                    stats.Total++;
                    
                    var isInternational = internationalCategories.indexOf(pub.category) > -1;
                    var isDomestic = pub.category === 'Khác';

                    if (pub.role === 'Tác giả chính') {
                        if (isInternational) roleStats.international.mainAuthor++;
                        if (isDomestic) roleStats.domestic.mainAuthor++;
                    } else if (pub.role === 'Đồng tác giả') {
                        if (isInternational) roleStats.international.coAuthor++;
                        if (isDomestic) roleStats.domestic.coAuthor++;
                    }
                });

                statsContainer.innerHTML = [
                    '<div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">',
                        '<div class="p-4 bg-gray-50 rounded-lg"><h3 class="text-sm sm:text-base font-semibold text-gray-500 uppercase">' + translations[currentLang].totalCount + '</h3><p class="text-4xl sm:text-5xl font-bold text-gray-800">' + stats.Total + '</p></div>',
                        '<div class="p-4 bg-blue-50 rounded-lg"><h3 class="text-sm sm:text-base font-semibold text-blue-500 uppercase">WoS</h3><p class="text-4xl sm:text-5xl font-bold text-blue-600">' + stats.WoS + '</p></div>',
                        '<div class="p-4 bg-green-50 rounded-lg"><h3 class="text-sm sm:text-base font-semibold text-green-500 uppercase">SCOPUS</h3><p class="text-4xl sm:text-5xl font-bold text-green-600">' + stats.SCOPUS + '</p></div>',
                        '<div class="p-4 bg-purple-50 rounded-lg"><h3 class="text-sm sm:text-base font-semibold text-purple-500 uppercase">WoS/SCOPUS</h3><p class="text-4xl sm:text-5xl font-bold text-purple-600">' + stats['WoS/SCOPUS'] + '</p></div>',
                        '<div class="p-4 bg-yellow-50 rounded-lg"><h3 class="text-sm sm:text-base font-semibold text-yellow-500 uppercase">' + translations[currentLang].other + '</h3><p class="text-4xl sm:text-5xl font-bold text-yellow-600">' + stats['Khác'] + '</p></div>',
                    '</div>'
                ].join('');
                
                detailedStatsContainer.innerHTML = [
                    '<div class="p-6 rounded-lg bg-slate-50 font-slab">',
                        '<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">',
                            // Thống kê bài báo quốc tế
                            '<div>',
                                '<h3 class="text-xl font-bold text-slate-800 mb-3" data-translate="internationalArticles">Bài báo quốc tế</h3>',
                                '<div class="space-y-2">',
                                    '<p class="text-lg"><span class="font-bold text-red-600" data-translate="statsMainAuthor">Tác giả chính</span>: <span class="text-2xl font-bold">' + roleStats.international.mainAuthor + '</span></p>',
                                    '<p class="text-lg"><span class="font-bold text-green-600" data-translate="statsCoAuthor">Đồng tác giả</span>: <span class="text-2xl font-bold">' + roleStats.international.coAuthor + '</span></p>',
                                '</div>',
                            '</div>',
                            // Thống kê bài báo trong nước
                            '<div>',
                                '<h3 class="text-xl font-bold text-slate-800 mb-3" data-translate="domesticArticles">Bài báo trong nước</h3>',
                                '<div class="space-y-2">',
                                    '<p class="text-lg"><span class="font-bold text-red-600" data-translate="statsMainAuthor">Tác giả chính</span>: <span class="text-2xl font-bold">' + roleStats.domestic.mainAuthor + '</span></p>',
                                    '<p class="text-lg"><span class="font-bold text-green-600" data-translate="statsCoAuthor">Đồng tác giả</span>: <span class="text-2xl font-bold">' + roleStats.domestic.coAuthor + '</span></p>',
                                '</div>',
                            '</div>',
                        '</div>',
                    '</div>'
                ].join('');

                var groupedByYear = allDocs.reduce(function(acc, doc) {
                    var year = doc.data().year || 'Chưa rõ';
                    if (!acc[year]) acc[year] = [];
                    acc[year].push(doc);
                    return acc;
                }, {});

                var sortedYears = Object.keys(groupedByYear).sort(function(a, b) { return b - a; });
                
                var counter = 1;
                sortedYears.forEach(function(year) {
                    var yearHeader = document.createElement('h2');
                    yearHeader.className = 'text-2xl font-bold mt-8 mb-2 border-b pb-2';
                    yearHeader.textContent = translations[currentLang].yearPrefix + year;
                    listContainer.appendChild(yearHeader);

                    var pubsInYear = groupedByYear[year];
                    pubsInYear.sort(function(a, b) { return (a.data().title || '').localeCompare(b.data().title || ''); });

                    pubsInYear.forEach(function(doc) {
                        var pub = doc.data();
                        var item = document.createElement('div');
                        item.className = 'text-base leading-relaxed flex items-start';
                        
                        var authorsString = pub.authors || '';
                        var authorsHtml = authorsString.split(',').map(function(name) {
                            var trimmedName = name.trim();
                            if (trimmedName === 'Trần Bình Thắng' || trimmedName === 'Binh Thang Tran') {
                                return '<strong class="font-bold text-red-800">' + trimmedName + '</strong>';
                            }
                            return trimmedName;
                        }).join(', ');

                        var titleLink = pub.link ? '<a href="' + pub.link + '" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:underline">' + pub.title + '</a>' : pub.title;
                        var journalDisplay = pub.journal ? '<em class="italic">' + pub.journal + (pub.volume ? ', ' + pub.volume : '') + '</em>.' : '';
                        
                        var roleText = pub.role;
                        if(currentLang === 'en') {
                            if(roleText === 'Tác giả chính') roleText = 'Main Author';
                            if(roleText === 'Đồng tác giả') roleText = 'Co-author';
                        }

                        item.innerHTML = [
                            '<span class="mr-3 text-gray-500">' + counter + '.</span>',
                            '<p>',
                                authorsHtml,
                                '(' + (pub.year || 'N/A') + '). ',
                                titleLink + '. ',
                                journalDisplay,
                                ' <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded">' + (pub.category || '') + '</span>. ',
                                '<strong class="font-bold text-gray-800">' + (roleText || '') + '</strong>',
                            '</p>'
                        ].join('');
                        listContainer.appendChild(item);
                        counter++;
                    });
                });
            }

            function renderManagementData(snapshot) {
                var tableBody = document.getElementById('publication-table-body');
                tableBody.innerHTML = '';
                if (snapshot.empty) {
                     tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-gray-500">' + translations[currentLang].noPublications + '</td></tr>';
                     return;
                }
                var sortedDocs = [];
                snapshot.forEach(function(doc){ sortedDocs.push(doc); });
                sortedDocs.sort(function(a, b) { return (parseInt(b.data().year, 10) || 0) - (parseInt(a.data().year, 10) || 0); });
                
                sortedDocs.forEach(function(doc) {
                    var pub = doc.data();
                    var row = document.createElement('tr');
                    row.innerHTML = [
                        '<td class="px-6 py-4"><div class="text-sm font-medium text-gray-900">' + pub.title + '</div></td>',
                        '<td class="px-6 py-4"><div class="text-sm text-gray-600">' + pub.authors + '</div></td>',
                        '<td class="px-6 py-4"><div class="text-sm text-gray-600">' + pub.year + '</div></td>',
                        '<td class="px-6 py-4"><div class="text-sm text-gray-600">' + pub.category + '</div></td>',
                        '<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">',
                            '<button class="edit-btn text-blue-600 hover:text-blue-900 mr-3" data-id="' + doc.id + '"><i data-lucide="file-pen-line" class="w-5 h-5"></i></button>',
                            '<button class="delete-btn text-red-600 hover:text-red-900" data-id="' + doc.id + '"><i data-lucide="trash-2" class="w-5 h-5"></i></button>',
                        '</td>'
                    ].join('');
                    tableBody.appendChild(row);
                });
                lucide.createIcons();
            }

            // --- LOGIC FORM QUẢN LÝ (Thêm, Sửa, Xóa) ---
            var publicationForm = document.getElementById('publication-form');
            var formTitle = document.getElementById('form-title');
            var submitBtn = document.getElementById('submit-btn');
            var cancelBtn = document.getElementById('cancel-edit-btn');
            var publicationIdInput = document.getElementById('publication-id');

            publicationForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (!publicationsCollectionRef) return;
                var publicationData = {
                    title: document.getElementById('publication-title').value,
                    authors: document.getElementById('publication-authors').value,
                    journal: document.getElementById('publication-journal').value,
                    volume: document.getElementById('publication-volume').value,
                    year: document.getElementById('publication-year').value,
                    category: document.getElementById('publication-category').value,
                    role: document.getElementById('publication-role').value,
                    link: document.getElementById('publication-link').value,
                };
                var id = publicationIdInput.value;
                if (id) {
                    publicationsCollectionRef.doc(id).update(publicationData).then(resetForm);
                } else {
                    publicationsCollectionRef.add(publicationData).then(resetForm);
                }
            });

            document.getElementById('management-view').addEventListener('click', function(e) {
                var button = e.target.closest('button.edit-btn, button.delete-btn');
                if (!button || !publicationsCollectionRef) return;

                var id = button.dataset.id;
                var docRef = publicationsCollectionRef.doc(id);

                if (button.classList.contains('delete-btn')) {
                    if (confirm(translations[currentLang].confirmDelete)) {
                        docRef.delete();
                    }
                } else if (button.classList.contains('edit-btn')) {
                    docRef.get().then(function(doc) {
                        if (doc.exists) {
                            var data = doc.data();
                            publicationIdInput.value = id;
                            document.getElementById('publication-title').value = data.title || '';
                            document.getElementById('publication-authors').value = data.authors || '';
                            document.getElementById('publication-journal').value = data.journal || '';
                            document.getElementById('publication-volume').value = data.volume || '';
                            document.getElementById('publication-year').value = data.year || '';
                            document.getElementById('publication-category').value = data.category || 'Khác';
                            document.getElementById('publication-role').value = data.role || 'Tác giả chính';
                            document.getElementById('publication-link').value = data.link || '';

                            formTitle.textContent = translations[currentLang].editPublication;
                            submitBtn.textContent = translations[currentLang].updateBtn;
                            submitBtn.classList.remove('bg-blue-600');
                            submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                            cancelBtn.classList.remove('hidden');
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                }
            });

            function resetForm() {
                publicationForm.reset();
                publicationIdInput.value = '';
                formTitle.textContent = translations[currentLang].addNewPublication;
                submitBtn.textContent = translations[currentLang].addBtn;
                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitBtn.classList.add('bg-blue-600');
                cancelBtn.classList.add('hidden');
            }
            cancelBtn.addEventListener('click', resetForm);
            
            // --- LOGIC TẢI CSV ---
            var downloadCSV = function() {
                if (!publicationsCollectionRef) return alert(translations[currentLang].downloadError);
                publicationsCollectionRef.get().then(function(snapshot) {
                    if (snapshot.empty) return alert(translations[currentLang].noDataToDownload);

                    var headers = ["Tên bài báo", "Tên tác giả", "Tạp chí", "Tập (số)", "Năm", "Danh mục", "Vai trò", "Đường dẫn"];
                    var escapeCsvCell = function(cell) {
                        if (cell === null || cell === undefined) return '';
                        var strCell = String(cell);
                        if (strCell.includes(',') || strCell.includes('"') || strCell.includes('\n')) {
                            return '"' + strCell.replace(/"/g, '""') + '"';
                        }
                        return strCell;
                    };

                    var csvRows = [headers.join(',')];
                    snapshot.forEach(function(doc) {
                        var data = doc.data();
                        var row = [
                            escapeCsvCell(data.title), escapeCsvCell(data.authors),
                            escapeCsvCell(data.journal), escapeCsvCell(data.volume),
                            escapeCsvCell(data.year), escapeCsvCell(data.category),
                            escapeCsvCell(data.role), escapeCsvCell(data.link)
                        ];
                        csvRows.push(row.join(','));
                    });

                    var csvString = csvRows.join('\n');
                    var blob = new Blob(['\uFEFF' + csvString], { type: 'text/csv;charset=utf-8;' });
                    
                    var link = document.createElement("a");
                    var url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", "danh-sach-an-pham.csv");
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            };

            downloadCsvBtn.addEventListener('click', downloadCSV);

            // --- KHỞI TẠO BAN ĐẦU ---
            document.querySelectorAll('.lang-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    setLanguage(btn.getAttribute('data-lang'));
                });
            });
            setLanguage('vi'); // Đặt ngôn ngữ mặc định
            lucide.createIcons();
        };
    </script>
</body>
</html>
